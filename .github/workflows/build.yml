name: Build Android APK

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip openjdk-17-jdk python3-pip \
            python3-dev build-essential libffi-dev libssl-dev \
            libncurses5-dev libncursesw5-dev libreadline-dev \
            libsqlite3-dev libgdbm-dev libdb5.3-dev libbz2-dev \
            libexpat1-dev liblzma-dev zlib1g-dev cython3 \
            autoconf automake libtool pkg-config cmake \
            expect wget

      - name: Install Buildozer
        run: |
          pip3 install --upgrade pip
          pip3 install --user buildozer
          echo "/home/runner/.local/bin" >> $GITHUB_PATH

      - name: Configure Buildozer
        run: |
          echo "=== 阶段 1: 强制初始化 ==="
          rm -f buildozer.spec
          buildozer init -y
          
          echo "=== 阶段 2: 逐行配置buildozer.spec ==="
          
          # 备份原始文件
          cp buildozer.spec buildozer.spec.backup
          
          # 创建一个新的spec文件
          {
            # 复制原始文件直到Android配置部分
            sed '/^\[app\]/,/^\[/p;d' buildozer.spec.backup | head -50
            
            echo ""
            echo "# ===== Android配置（自定义）====="
            echo ""
            echo "# 应用信息"
            echo "title = 黄金监控"
            echo "package.name = goldmonitor"
            echo "package.domain = org.test"
            echo ""
            echo "# 源代码"
            echo "source.dir = ."
            echo "source.main = main19.py"
            echo "source.include_exts = py,png,jpg,kv,atlas,ttc,ttf"
            echo ""
            echo "# 依赖"
            echo "requirements = python3,kivy,kivymd,requests"
            echo ""
            echo "# Android配置"
            echo "android.api = 33"
            echo "android.minapi = 21"
            echo "android.sdk = 33"
            echo "android.ndk = 25.1.8937393"
            echo "# 注释掉默认的build-tools版本"
            echo "# android.build_tools_version = "
            echo "android.permissions = INTERNET,VIBRATE"
            echo "orientation = portrait"
            echo ""
            
            # 复制原始文件的其余部分
            sed -n '/^\[buildozer\]/,$p' buildozer.spec.backup
          } > buildozer.spec
          
          echo "=== 阶段 3: 验证配置 ==="
          echo "配置完成，显示关键部分:"
          echo "------------------------"
          grep -E "^(title|package\.|source\.|requirements|android\.|orientation)" buildozer.spec
          echo "------------------------"
          echo "✅ buildozer.spec 配置完成"

      # --- 安装Android SDK命令行工具 ---
      - name: Install Android SDK Command Line Tools
        run: |
          echo "=== 安装Android SDK命令行工具 ==="
          
          SDK_DIR="/home/runner/android-sdk"
          mkdir -p "$SDK_DIR"
          
          cd /tmp
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-*.zip
          
          mkdir -p "$SDK_DIR/cmdline-tools/latest"
          mv cmdline-tools/* "$SDK_DIR/cmdline-tools/latest/"
          
          echo "ANDROID_HOME=$SDK_DIR" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$SDK_DIR" >> $GITHUB_ENV
          echo "PATH=$SDK_DIR/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV
          
          echo "✅ Android SDK命令行工具安装完成"
          echo "SDK路径: $SDK_DIR"

      - name: Prepare Android SDK Licenses
        run: |
          echo "=== 准备Android SDK许可证 ==="
          SDK_PATH="$ANDROID_HOME"
          mkdir -p "$SDK_PATH/licenses"
          
          # 写入完整的许可证文件
          echo -e "8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e" > "$SDK_PATH/licenses/android-sdk-license"
          echo -e "84831b9409646a918e30573bab4c9c91346d8abd" > "$SDK_PATH/licenses/android-sdk-preview-license"
          echo "601085b94cd77f0b54ff86406957099ebe79c4d6" > "$SDK_PATH/licenses/android-googletv-license"
          echo "33b6a2b64607f11b759f320ef9dff4ae5c47d97a" > "$SDK_PATH/licenses/android-sdk-arm-dbt-license"
          echo "e9acab5b5fbb560a72cfaecce8946896ff6aab9d" > "$SDK_PATH/licenses/google-gdk-license"
          
          echo "✅ 许可证文件已创建"

      - name: Install Android SDK Components
        run: |
          echo "=== 安装Android SDK组件 ==="
          SDK_PATH="$ANDROID_HOME"
          
          # 接受许可证
          echo "y" | $SDK_PATH/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
          
          # 安装Buildozer需要的版本和我们配置的版本
          echo "安装Android SDK组件..."
          $SDK_PATH/cmdline-tools/latest/bin/sdkmanager --install \
            "platforms;android-33" \
            "build-tools;36.1.0" \
            "build-tools;33.0.2" \
            "platform-tools" \
            "cmdline-tools;latest"
          
          echo "✅ Android SDK组件安装完成"

      # --- 关键步骤：将SDK复制到Buildozer目录 ---
      - name: Copy Android SDK to Buildozer Directory
        run: |
          echo "=== 将Android SDK复制到Buildozer目录 ==="
          
          # Buildozer期望的路径
          BUILDOZER_SDK_DIR="/home/runner/.buildozer/android/platform/android-sdk"
          
          # 我们安装的SDK路径
          OUR_SDK_DIR="$ANDROID_HOME"
          
          echo "源路径: $OUR_SDK_DIR"
          echo "目标路径: $BUILDOZER_SDK_DIR"
          
          # 确保目标目录存在
          mkdir -p "$(dirname "$BUILDOZER_SDK_DIR")"
          
          # 如果已存在，先删除
          rm -rf "$BUILDOZER_SDK_DIR"
          
          # 复制整个SDK目录
          cp -r "$OUR_SDK_DIR" "$BUILDOZER_SDK_DIR"
          
          # 验证复制结果
          echo "验证SDK目录内容:"
          ls -la "$BUILDOZER_SDK_DIR/build-tools/" 2>/dev/null | head -5 || echo "build-tools目录尚未创建"
          
          echo "✅ Android SDK已复制到Buildozer目录"

      - name: Build APK
        timeout-minutes: 120
        env:
          # 设置环境变量让Buildozer使用正确的SDK
          ANDROID_HOME: "/home/runner/.buildozer/android/platform/android-sdk"
          ANDROID_SDK_ROOT: "/home/runner/.buildozer/android/platform/android-sdk"
        run: |
          echo "=== 开始构建APK ==="
          
          # 构建前确认环境
          echo "当前环境变量:"
          echo "ANDROID_HOME=$ANDROID_HOME"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          
          echo "Buildozer spec配置摘要:"
          grep -E "^(android\.|requirements|title)" buildozer.spec
          
          echo "开始执行 buildozer android debug..."
          # 增加详细日志输出
          buildozer -v android debug 2>&1 | tail -100

      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: gold-monitor-apk
          path: bin/*.apk
          retention-days: 7

name: Build Android APK

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip openjdk-17-jdk python3-pip \
            python3-dev build-essential libffi-dev libssl-dev \
            libncurses5-dev libncursesw5-dev libreadline-dev \
            libsqlite3-dev libgdbm-dev libdb5.3-dev libbz2-dev \
            libexpat1-dev liblzma-dev zlib1g-dev cython3 \
            autoconf automake libtool pkg-config cmake \
            expect

      - name: Install Buildozer
        run: |
          pip3 install --upgrade pip
          pip3 install --user buildozer
          echo "/home/runner/.local/bin" >> $GITHUB_PATH

      - name: Configure Buildozer
        run: |
          echo "=== 阶段 1: 强制初始化 ==="
          rm -f buildozer.spec
          buildozer init -y
          echo "✅ buildozer.spec 已生成"

          echo "=== 阶段 2: 配置Spec文件 ==="
          sed -i "s|^title = .*|title = 黄金监控|g" buildozer.spec
          sed -i "s|^package.name = .*|package.name = goldmonitor|g" buildozer.spec
          sed -i "s|^package.domain = .*|package.domain = org.test|g" buildozer.spec
          sed -i "s|^source.dir = .*|source.dir = .|g" buildozer.spec
          sed -i "s|^source.main = .*|source.main = main19.py|g" buildozer.spec
          sed -i "s|^source.include_exts = .*|source.include_exts = py,png,jpg,kv,atlas,ttc,ttf|g" buildozer.spec
          sed -i "s|^requirements = .*|requirements = python3,kivy,kivymd,requests|g" buildozer.spec
          sed -i "s|^android.api = .*|android.api = 33|g" buildozer.spec
          sed -i "s|^android.minapi = .*|android.minapi = 21|g" buildozer.spec
          sed -i "s|^android.sdk = .*|android.sdk = 33|g" buildozer.spec
          sed -i "s|^android.ndk = .*|android.ndk = 25.1.8937393|g" buildozer.spec
          sed -i "s|^android.permissions = .*|android.permissions = INTERNET,VIBRATE|g" buildozer.spec
          sed -i "s|^orientation = .*|orientation = portrait|g" buildozer.spec

          echo "=== 阶段 3: 验证配置 ==="
          echo "当前工作目录:"
          pwd
          echo "spec文件前5行:"
          head -5 buildozer.spec

      - name: Prepare Android SDK Licenses (直接写入文件)
        run: |
          echo "=== 准备Android SDK许可证 ==="
          SDK_PATH="/home/runner/.buildozer/android/platform/android-sdk"
          
          # 确保目录存在
          mkdir -p "$SDK_PATH/licenses"
          
          # 写入标准Android SDK许可证
          echo -e "8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e" > "$SDK_PATH/licenses/android-sdk-license"
          echo -e "84831b9409646a918e30573bab4c9c91346d8abd" > "$SDK_PATH/licenses/android-sdk-preview-license"
          
          echo "✅ 许可证文件已创建"

      - name: Install Android SDK Components
        run: |
          echo "=== 安装Android SDK组件 ==="
          SDK_PATH="/home/runner/.buildozer/android/platform/android-sdk"
          
          # 安装基础组件（使用--sdk_root避免交互）
          $SDK_PATH/tools/bin/sdkmanager --install \
            "platforms;android-33" \
            "build-tools;33.0.2" \
            "platform-tools" \
            --sdk_root="$SDK_PATH"
          
          echo "✅ Android SDK组件安装完成"

      - name: Build APK
        timeout-minutes: 90
        run: |
          echo "=== 开始构建APK ==="
          buildozer -v android debug

      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: gold-monitor-apk
          path: bin/*.apk
          retention-days: 7

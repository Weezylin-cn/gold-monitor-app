name: Build Android APK

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip openjdk-17-jdk python3-pip \
            python3-dev build-essential libffi-dev libssl-dev \
            libncurses5-dev libncursesw5-dev libreadline-dev \
            libsqlite3-dev libgdbm-dev libdb5.3-dev libbz2-dev \
            libexpat1-dev liblzma-dev zlib1g-dev cython3 \
            autoconf automake libtool pkg-config cmake \
            expect wget

      - name: Install Buildozer
        run: |
          pip3 install --upgrade pip
          pip3 install --user buildozer
          echo "/home/runner/.local/bin" >> $GITHUB_PATH

      - name: Configure Buildozer (修复重复配置问题)
        run: |
          echo "=== 阶段 1: 强制初始化 ==="
          rm -f buildozer.spec
          buildozer init -y
          
          echo "=== 阶段 2: 逐行创建spec文件 ==="
          
          # 完全删除旧文件，逐行创建新文件
          rm -f buildozer.spec
          
          # 使用echo逐行创建，避免多行文本语法问题
          echo "[app]" >> buildozer.spec
          echo "" >> buildozer.spec
          echo "# ===== 应用信息 =====" >> buildozer.spec
          echo "title = 黄金监控" >> buildozer.spec
          echo "package.name = goldmonitor" >> buildozer.spec
          echo "package.domain = org.test" >> buildozer.spec
          # 添加必需的version配置
          echo "version = 1.0.0" >> buildozer.spec
          echo "" >> buildozer.spec
          echo "# ===== 源代码配置 =====" >> buildozer.spec
          echo "source.dir = ." >> buildozer.spec
          echo "source.main = main19.py" >> buildozer.spec
          echo "source.include_exts = py,png,jpg,kv,atlas,ttc,ttf" >> buildozer.spec
          echo "" >> buildozer.spec
          echo "# ===== 需求/依赖 =====" >> buildozer.spec
          echo "requirements = python3,kivy,kivymd,requests" >> buildozer.spec
          echo "" >> buildozer.spec
          echo "# ===== Android配置 =====" >> buildozer.spec
          echo "android.api = 33" >> buildozer.spec
          echo "android.minapi = 21" >> buildozer.spec
          echo "android.sdk = 33" >> buildozer.spec
          # 使用Buildozer推荐的NDK版本
          echo "android.ndk = 25.1.8937393" >> buildozer.spec  # 25b版本
          echo "android.permissions = INTERNET,VIBRATE" >> buildozer.spec
          echo "orientation = portrait" >> buildozer.spec
          echo "" >> buildozer.spec
          echo "[buildozer]" >> buildozer.spec
          echo "" >> buildozer.spec
          echo "# ===== Buildozer配置 =====" >> buildozer.spec
          echo "log_level = 2" >> buildozer.spec
          echo "warn_on_root = 1" >> buildozer.spec
          
          echo "=== 阶段 3: 验证配置 ==="
          echo "新创建的buildozer.spec文件前30行:"
          echo "------------------------"
          head -30 buildozer.spec
          echo "------------------------"
          echo "检查是否有重复项:"
          # 检查每个选项是否只出现一次
          for option in title version package.name package.domain source.dir source.main requirements android.api android.sdk android.ndk; do
            count=$(grep -c "^$option = " buildozer.spec)
            if [ "$count" -gt 1 ]; then
              echo "❌ $option 出现了 $count 次（应该只出现1次）"
            else
              echo "✅ $option 出现 $count 次"
            fi
          done
          echo "✅ buildozer.spec 配置完成（无重复项）"

      # --- 安装Android SDK命令行工具 ---
      - name: Install Android SDK Command Line Tools
        run: |
          echo "=== 安装Android SDK命令行工具 ==="
          
          SDK_DIR="/home/runner/android-sdk"
          mkdir -p "$SDK_DIR"
          
          cd /tmp
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-*.zip
          
          mkdir -p "$SDK_DIR/cmdline-tools/latest"
          mv cmdline-tools/* "$SDK_DIR/cmdline-tools/latest/"
          
          echo "ANDROID_HOME=$SDK_DIR" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$SDK_DIR" >> $GITHUB_ENV
          echo "PATH=$SDK_DIR/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV
          
          echo "✅ Android SDK命令行工具安装完成"
          echo "SDK路径: $SDK_DIR"

      - name: Prepare Android SDK Licenses
        run: |
          echo "=== 准备Android SDK许可证 ==="
          SDK_PATH="$ANDROID_HOME"
          mkdir -p "$SDK_PATH/licenses"
          
          # 写入完整的许可证文件
          echo -e "8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e" > "$SDK_PATH/licenses/android-sdk-license"
          echo -e "84831b9409646a918e30573bab4c9c91346d8abd" > "$SDK_PATH/licenses/android-sdk-preview-license"
          echo "601085b94cd77f0b54ff86406957099ebe79c4d6" > "$SDK_PATH/licenses/android-googletv-license"
          echo "33b6a2b64607f11b759f320ef9dff4ae5c47d97a" > "$SDK_PATH/licenses/android-sdk-arm-dbt-license"
          echo "e9acab5b5fbb560a72cfaecce8946896ff6aab9d" > "$SDK_PATH/licenses/google-gdk-license"
          
          echo "✅ 许可证文件已创建"

      - name: Install Android SDK Components
        run: |
          echo "=== 安装Android SDK组件 ==="
          SDK_PATH="$ANDROID_HOME"
          
          # 接受许可证
          echo "y" | $SDK_PATH/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
          
          # 安装Buildozer需要的版本和我们配置的版本
          echo "安装Android SDK组件..."
          $SDK_PATH/cmdline-tools/latest/bin/sdkmanager --install \
            "platforms;android-33" \
            "build-tools;36.1.0" \
            "build-tools;33.0.2" \
            "platform-tools" \
            "cmdline-tools;latest"
          
          echo "✅ Android SDK组件安装完成"

      # --- 强制预下载Android NDK（多版本尝试）---
      - name: Download Android NDK (多版本尝试)
        timeout-minutes: 60
        run: |
          echo "=== 强制下载Android NDK（多版本尝试）==="
          
          # 设置NDK路径
          NDK_DIR="/home/runner/.buildozer/android/platform"
          
          # 创建目录
          mkdir -p "$NDK_DIR"
          cd "$NDK_DIR"
          
          echo "当前目录: $(pwd)"
          echo "检查现有NDK:"
          find . -name "android-ndk-*" -type d 2>/dev/null | head -5 || echo "无NDK目录"
          
          # 检查是否已存在任何NDK版本
          if find . -name "android-ndk-*" -type d | grep -q .; then
            echo "✅ 已有NDK目录存在"
            echo "现有NDK目录:"
            find . -name "android-ndk-*" -type d
            echo "跳过下载"
            exit 0
          fi
          
          echo "尝试下载Android NDK..."
          echo "注意：NDK约1.5GB，下载需要时间..."
          
          # 尝试多个可能的NDK版本
          # Google的NDK版本命名有时不一致
          POSSIBLE_VERSIONS=(
            "r25b"
            "r25.1.8937393"
            "r25"
            "r24"
            "r23c"
          )
          
          for VERSION in "${POSSIBLE_VERSIONS[@]}"; do
            NDK_FILE="android-ndk-${VERSION}-linux.zip"
            NDK_URL="https://dl.google.com/android/repository/${NDK_FILE}"
            
            echo "尝试版本: $VERSION"
            echo "URL: $NDK_URL"
            
            # 尝试下载
            if wget -c --tries=2 --timeout=120 --show-progress "$NDK_URL" 2>&1 | tail -5; then
              echo "✅ 下载成功: $VERSION"
              
              # 验证文件大小
              FILE_SIZE=$(stat -c%s "$NDK_FILE" 2>/dev/null || echo "0")
              echo "文件大小: $FILE_SIZE 字节"
              
              if [ "$FILE_SIZE" -gt 1000000000 ]; then
                echo "文件大小正常，解压..."
                unzip -q "$NDK_FILE" && {
                  echo "✅ NDK解压成功"
                  echo "NDK目录:"
                  find . -name "android-ndk-*" -type d
                  exit 0
                } || echo "❌ 解压失败"
              else
                echo "❌ 文件太小，删除..."
                rm -f "$NDK_FILE"
              fi
            else
              echo "❌ 版本 $VERSION 不可用"
              rm -f "$NDK_FILE" 2>/dev/null || true
            fi
          done
          
          echo "⚠️ 所有NDK版本尝试失败"
          echo "Buildozer将尝试自行下载"
          echo "NDK下载步骤完成"

      # --- 关键步骤：将SDK复制到Buildozer目录 ---
      - name: Copy Android SDK to Buildozer Directory
        run: |
          echo "=== 将Android SDK复制到Buildozer目录 ==="
          
          # Buildozer期望的路径
          BUILDOZER_SDK_DIR="/home/runner/.buildozer/android/platform/android-sdk"
          
          # 我们安装的SDK路径
          OUR_SDK_DIR="$ANDROID_HOME"
          
          echo "源路径: $OUR_SDK_DIR"
          echo "目标路径: $BUILDOZER_SDK_DIR"
          
          # 确保目标目录存在
          mkdir -p "$(dirname "$BUILDOZER_SDK_DIR")"
          
          # 如果已存在，先删除
          rm -rf "$BUILDOZER_SDK_DIR"
          
          # 复制整个SDK目录
          cp -r "$OUR_SDK_DIR" "$BUILDOZER_SDK_DIR"
          
          # 验证复制结果
          echo "验证SDK目录内容:"
          ls -la "$BUILDOZER_SDK_DIR/build-tools/" 2>/dev/null | head -5 || echo "build-tools目录尚未创建"
          
          echo "✅ Android SDK已复制到Buildozer目录"

      # --- Build APK 步骤（带详细调试和NDK检查）---
      - name: Build APK (带详细调试和NDK检查)
        timeout-minutes: 240  # 增加到240分钟
        env:
          ANDROID_HOME: "/home/runner/.buildozer/android/platform/android-sdk"
          ANDROID_SDK_ROOT: "/home/runner/.buildozer/android/platform/android-sdk"
          # 添加构建优化环境变量
          BUILD_OZER_ARGS: "--color=always"
        run: |
          echo "=== 开始构建APK（详细模式）==="
          
          # 1. 构建前环境检查
          echo "1. 环境检查:"
          echo "   当前目录: $(pwd)"
          echo "   目录内容:"
          ls -la
          echo ""
          echo "   buildozer.spec 是否存在:"
          ls -la buildozer.spec 2>/dev/null || echo "   ❌ 不存在"
          echo ""
          echo "   主文件 main19.py 是否存在:"
          ls -la main19.py 2>/dev/null || echo "   ❌ 不存在"
          
          # 2. 显示buildozer配置
          echo "2. buildozer.spec 关键配置:"
          grep -E "^(title|version|package\.|source\.|requirements|android\.)" buildozer.spec || echo "   无法读取配置"
          
          # 3. 检查Android SDK
          echo "3. Android SDK 检查:"
          echo "   ANDROID_HOME: $ANDROID_HOME"
          ls -la "$ANDROID_HOME/build-tools/" 2>/dev/null | head -5 || echo "   ❌ build-tools目录不存在"
          
          # 3.5 检查Android NDK
          echo "3.5 Android NDK 检查:"
          echo "   检查NDK目录是否存在..."
          NDK_PATH="/home/runner/.buildozer/android/platform"
          echo "   NDK根目录: $NDK_PATH"
          echo "   目录内容:"
          ls -la "$NDK_PATH/" 2>/dev/null | head -10 || echo "   无法访问NDK目录"
          echo "   查找android-ndk-*目录:"
          find "$NDK_PATH" -name "android-ndk-*" -type d 2>/dev/null | head -5 || echo "   未找到NDK目录"
          
          # 4. 运行buildozer并捕获所有输出
          echo "4. 开始执行 buildozer..."
          echo "================================"
          
          # 尝试多次构建（如果NDK下载失败会自动重试）
          MAX_RETRIES=5  # 增加到5次
          for i in $(seq 1 $MAX_RETRIES); do
            echo "尝试第 $i/$MAX_RETRIES 次构建..."
            
            # 保存输出到文件以便分析
            buildozer -v android debug 2>&1 | tee buildozer_output.log
            BUILD_STATUS=${PIPESTATUS[0]}
            
            if [ $BUILD_STATUS -eq 0 ]; then
              echo "✅ 构建成功！"
              break
            elif grep -q "read of closed file\|ValueError\|404\|Not Found" buildozer_output.log; then
              echo "⚠️ NDK下载问题，等待60秒后重试..."
              sleep 60
            else
              echo "❌ 其他错误，不再重试"
              break
            fi
          done
          
          echo "================================"
          echo "5. 最终构建完成，退出码: $BUILD_STATUS"
          
          # 6. 检查输出文件
          echo "6. 检查输出文件:"
          ls -la bin/ 2>/dev/null || echo "   bin目录不存在"
          find . -name "*.apk" 2>/dev/null | head -5 || echo "   未找到.apk文件"
          
          # 7. 显示buildozer日志的最后部分
          echo "7. buildozer输出最后50行:"
          tail -50 buildozer_output.log 2>/dev/null || echo "   无日志文件"
          
          # 8. 如果有错误，显示错误部分
          if [ $BUILD_STATUS -ne 0 ]; then
            echo "8. 构建失败，错误信息:"
            grep -A 5 -B 5 -i "error\|fail\|exception\|traceback\|closed\|404\|Not Found" buildozer_output.log 2>/dev/null | head -30 || echo "   未找到明显错误信息"
          fi
          
          # 9. 根据退出码决定是否失败
          if [ $BUILD_STATUS -ne 0 ]; then
            echo "❌ buildozer构建失败，退出码: $BUILD_STATUS"
            exit $BUILD_STATUS
          else
            echo "✅ buildozer命令执行完成"
          fi

      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: gold-monitor-apk
          path: bin/*.apk
          retention-days: 7

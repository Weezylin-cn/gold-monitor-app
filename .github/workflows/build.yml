name: Build Android APK

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-17-jdk python3-pip
        sudo apt-get install -y python3-dev build-essential libffi-dev libssl-dev
        sudo apt-get install -y libncurses5-dev libncursesw5-dev libreadline-dev
        sudo apt-get install -y libsqlite3-dev libgdbm-dev libdb5.3-dev libbz2-dev
        sudo apt-get install -y libexpat1-dev liblzma-dev zlib1g-dev cython3
        sudo apt-get install -y autoconf automake libtool pkg-config cmake
        # 增加依赖：expect，用于自动化交互式对话
        sudo apt-get install -y expect

    - name: Install Buildozer
      run: |
        pip3 install --upgrade pip
        pip3 install --user buildozer
        echo "/home/runner/.local/bin" >> $GITHUB_PATH

    - name: Configure Buildozer (关键步骤)
      run: |
        echo "=== 阶段 1: 强制初始化 ==="
        rm -f buildozer.spec
        buildozer init -y
        echo "✅ buildozer.spec 已生成"
        
        echo "=== 阶段 2: 配置Spec文件 ==="
        # 使用sed确保准确修改，避免重复追加
        sed -i "s|^title = .*|title = 黄金监控|g" buildozer.spec
        sed -i "s|^package.name = .*|package.name = goldmonitor|g" buildozer.spec
        sed -i "s|^package.domain = .*|package.domain = org.test|g" buildozer.spec
        sed -i "s|^source.dir = .*|source.dir = .|g" buildozer.spec
        sed -i "s|^source.main = .*|source.main = main19.py|g" buildozer.spec
        sed -i "s|^source.include_exts = .*|source.include_exts = py,png,jpg,kv,atlas,ttc,ttf|g" buildozer.spec
        sed -i "s|^requirements = .*|requirements = python3,kivy,kivymd,requests|g" buildozer.spec
        # ！！！ 核心修复：将SDK版本锁定为33，与我们手动安装的一致 ！！！
        sed -i "s|^android.api = .*|android.api = 33|g" buildozer.spec
        sed -i "s|^android.minapi = .*|android.minapi = 21|g" buildozer.spec
        sed -i "s|^android.sdk = .*|android.sdk = 33|g" buildozer.spec
        sed -i "s|^android.ndk = .*|android.ndk = 25.1.8937393|g" buildozer.spec
        sed -i "s|^android.permissions = .*|android.permissions = INTERNET,VIBRATE|g" buildozer.spec
        sed -i "s|^orientation = .*|orientation = portrait|g" buildozer.spec
        
        echo "=== 阶段 3: 验证配置 ==="
        echo "当前工作目录:"
        pwd
        echo "生成的 spec 文件前20行:"
        head -20 buildozer.spec
        echo "✅ Configure Buildozer 步骤完成"

    # --- 核心修复：使用 expect 脚本100%自动接受SDK许可证 ---
    - name: Accept Android SDK Licenses with Expect
      run: |
        echo "=== 开始使用 Expect 自动处理SDK许可证 ==="
        # 设置Android SDK路径 (Buildozer 使用的位置)
        export ANDROID_HOME="/home/runner/.buildozer/android/platform/android-sdk"
        export ANDROID_SDK_ROOT="$ANDROID_HOME"
        echo "SDK路径设置为: $ANDROID_HOME"
        
        # 方法1：直接使用expect命令处理许可证
        echo "方法1: 直接运行expect命令..."
        /usr/bin/expect << 'SCRIPT_EOF'
set timeout 60
spawn $env(ANDROID_HOME)/tools/bin/sdkmanager --licenses
expect {
    "Accept? (y/N):" { 
        send "y\r"
        exp_continue
    }
    timeout {
        send_user "超时\n"
        exit 1
    }
    eof
}
send_user "许可证接受流程完成\n"
SCRIPT_EOF
        
        echo "✅ Expect 脚本执行完毕"
        
        # 方法2：使用非交互式方式安装组件（避免yes命令问题）
        echo "开始安装 Android SDK 组件..."
        # 创建响应文件来避免交互
        mkdir -p "$ANDROID_HOME/licenses"
        echo -e "8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e\n" > "$ANDROID_HOME/licenses/android-sdk-license"
        echo -e "84831b9409646a918e30573bab4c9c91346d8abd\n" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
        
        # 使用sdkmanager的非交互模式
        $ANDROID_HOME/tools/bin/sdkmanager --install "platforms;android-33" "build-tools;33.0.2" "platform-tools" --sdk_root="$ANDROID_HOME" 2>&1 | grep -v "Warning:"
        
        echo "✅ Android SDK 平台和构建工具安装尝试完成"

    - name: Build APK
      timeout-minutes: 90
      run: |
        echo "=== 开始最终 APK 构建 ==="
        # 构建前再次确认环境
        echo "当前目录内容:"
        ls -la
        echo "开始执行 buildozer android debug..."
        buildozer -v android debug

    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: gold-monitor-apk
        path: bin/*.apk
        retention-days: 7
